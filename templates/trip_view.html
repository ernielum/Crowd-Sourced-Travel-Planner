<!-- 
    This page displays a specific user's trip and lists pinned experiences.
    Actions:
            - Edit trip link
            - Delete trip
            - Search more experiences link
            - Select Experience to view details
-->

<!doctype html>

<html>
<head>
    <meta charset="utf-8">
    <title>Crowd-sourced Travel App</title>
    <script src="https://maps.googleapis.com/maps/api/js?key={{API_KEY}}&libraries=places"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined">
    <!-- Dynamic User Rating Script (includes hover effect) -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const stars = document.querySelectorAll('#user-rating .user-star');
            let ratingValue = document.getElementById('userRatingValue').value;
            const form = document.getElementById('rate-experience'); // Reference to the form

            const updateRatingDisplay = (rating) => {
                stars.forEach((star, index) => {
                    star.classList.toggle('full-star', index < rating);
                    star.classList.toggle('empty-star', index >= rating);
                });
            };

            stars.forEach((star, index) => {
                // Preview rating on hover
                star.addEventListener('mouseover', () => updateRatingDisplay(index + 1));

                // Set rating on click and submit form
                star.addEventListener('click', () => {
                    var rating = index + 1;
                    // calculate rating from total star indices (modulus 5)
                    rating = rating % 5;
                    // account for ratings of 5, set to 5 rather than 0
                    if (rating == 0) {
                        rating = 5;
                    }
                    document.getElementById('userRatingValue').value = rating; // Update hidden input with the rating
                    updateRatingDisplay(rating);

                    // Get the parent form of the clicked star
                    const parentForm = star.closest('.rate-form');
                    // Get the experienceId associated with the parent form
                    const experienceId = parentForm.querySelector('input[name="experienceId"]').value;
                    // Update the hidden input with the experienceId
                    form.querySelector('input[name="experienceId"]').value = experienceId;

                    // Submit the form
                    form.submit();

                });

                // Reset preview on mouse out to reflect actual selected rating
                star.addEventListener('mouseleave', () => updateRatingDisplay(ratingValue));
            });

            // Reset to actual rating when not hovering over the stars
            document.getElementById('user-rating').addEventListener('mouseleave', () => {
                updateRatingDisplay(ratingValue);
            });
        });
    </script>
</head>

<body>
    <header>
        <div class="header-container">
            <h1>CROWD-sourced Travel App</h1>
            <a href="/logout" class="sign-in-link">
                Log Out
                <span class="material-symbols-outlined">account_circle</span>
            </a>
        </div>
        <!-- Navigation Links -->
        <div class="nav">
            <a href="{{ url_for('trips') }}">Return to My Trips</a>
        </div>
    </header>

    <div class="trip-view-page">
        <main>
            <div id="map"></div>

            <!-- Experience Search Bar -->
            <div class="search-bar-container">
                <span class="material-icons-outlined">search</span>
                <input type="text" id="place-search" placeholder="Find New Experiences">
                <button onclick="searchPlaces()">Search</button>

                <!-- Pin Experience Button -->
                <button onclick="pinExperience()" id="pin-button" style="display: none;">
                    <span class="material-symbols-outlined">keep</span>
                </button>
            </div>
            <br>

            <div class="experiences-table-container">
                <table class="experiences-table">
                    <!-- Table Header -->
                    <tr>
                        <th class="th-trip">
                            <!-- Trip name-->
                            {{ trip.name }}

                            <!-- Trip Action Buttons-->
                            <div class="button-container">
                                <div class="button-row">
                                    <!-- Edit Trip Button -->
                                    <form id="edit-trip" method="GET" action="/trip_edit">
                                        <button class="button-container-button" name="edit-trip" id="tripId"
                                            value="{{trip.id}}">
                                            <span class="material-symbols-outlined">edit</span>
                                        </button>
                                    </form>

                                    <!-- Delete Trip Button -->
                                    <form id="delete-trip" method="POST" action="/trip_delete">
                                        <button class="button-container-button" name="delete-trip" id="tripId"
                                            value="{{trip.id}}">
                                            <span class="material-symbols-outlined">delete</span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </th>
                    </tr>

                    <!-- Table Rows -->
                    {% for experience_data in experiences %}

                    <tr>{% include 'experience_td.html' %}</tr>

                    {% endfor %}
                </table>
            </div>
        </main>
    </div>
</body>
</html>